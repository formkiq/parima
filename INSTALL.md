# Parima

## Get Started

Parima was built using the [AWS Serverless Application Model (SAM)](https://aws.amazon.com/serverless/sam/) framework.

This project contains source code and supporting files for the [Parima](https://github.com/formkiq/parima) serverless application that you can deploy with the SAM CLI.

[Parima](https://github.com/formkiq/parima) uses AWS resources, including CloudFront, Lambda functions, and an API Gateway API. These resources are defined in the `template.yaml` file in this project. You can customize Parima by updating the template, adding AWS resources through the same deployment process that updates your application code.

## Deploy Parima

The Serverless Application Model Command Line Interface (SAM CLI) is an extension of the AWS CLI that adds functionality for deploying serverless applications.

To use SAM CLI, you will need to install the following tools:

* AWS CLI - [Install the AWS CLI](https://aws.amazon.com/cli/)
* SAM CLI - [Install the SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)

To deploy Parima for the first time, run the following in your shell from the root of this parima-1.x.x folder:

**NOTE:** It may take up to 15 minutes for the SAM CLI script to complete.

```bash
sam deploy --guided --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND CAPABILITY_NAMED_IAM
```

The command will package and deploy your application to AWS, with a series of prompts:

### **Stack Name**: 
The name of the stack to deploy to CloudFormation. This should be unique to your account and region.

### **AWS Region**:
 The AWS region you want to deploy your app to.

### **DomainName** (optional):
By default, CloudFront generates a random URL to access your website, such as https://*abcdefg99*.cloudfront.net.

You can specify a custom domain/Route 53 hosted zone during the installation of Parima, and that domain will be used for the website, e.g. www.mycompany.com.

**Note:** The domain needs to have a Route 53 Hosted Zone. e.g. Route 53 Hosted Zone mycompany.com must exist and the DNS must point to the Amazon Web Services' DNS.

A domain registered outside of AWS can be used (by setting up an Amazon Route 53 [Hosted Zone](https://console.aws.amazon.com/route53/v2/hostedzones#) and supplying the Nameserver entries that will be generated by Route 53 to your Domain Registrar), or a new domain can be registered within the AWS Management Console.

**[Register a Domain using Amazon Route 53](https://console.aws.amazon.com/route53/home#DomainRegistration:)** | **[Transfer a Domain to Amazon Route 53](https://console.aws.amazon.com/route53/home#DomainTransfer:)**

### **WebsiteVersion:**

Parima is set up to handle multiple versions of a website and easily switch between them. This CloudFormation parameter control which version of the website is active. By default a **v1** version is created. This means that you need to upload all your website contents to the **v1** directory inside of S3. 

Creating a **v2** version of your website is very easy. Upload your website contents to a **v2** directory and then run the CloudFormation script and specify **v2** in the **WebsiteVersion** parameter. This will tell CloudFront to serve files in the **v2** directory. If you want to switch baack to **v1**, just run the CloudFormation again and specify **v1** as the **WebsiteVersion**. Running CloudFormation to update will not overwrite any of your existing files.

### **GitDeploymentPath (optional):**

Use to specify a specific directory in the GIT repository to perform the deployment.

### **GitRepositoryUrl (optional):**

Use to specify a GIT url that contains the website to deploy. **NOTE:** Only GITHUB urls are currently supported.

### **GitBranch (optional):**

If using `GitRepositoryUrl`, you can specify a branch to deploy, defaults to master/main.

### **DeploymentType [static]:**

The type of website deployment to use.
- static - The website deployed is static and no special logic or build process is required.
- Hugo0.76.3 - Build the website using Hugo 0.76.3 before deployed.

### **Caching [Managed-CachingDisabled]:**

The Caching Stategy used: Managed-CachingDisabled, Managed-CachingOptimized, Managed-CachingOptimizedForUncompressedObjects, see https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html for more detail description.

### **SAM needs permission to be able to create roles to connect to the resources in your template**

Allow SAM CLI IAM role creation [Y/n]:
DeploymentLambda may not have authorization defined, Is this okay? [y/N]: y
DeploymentLambda may not have authorization defined, Is this okay? [y/N]: y

### **Confirm changes before deploy**:

If set to yes, any change sets will be shown to you before execution for manual review. If set to no, the AWS SAM CLI will automatically deploy application changes.

### **Allow SAM CLI IAM role creation**: 

Parima's AWS SAM templates create AWS IAM roles required for the AWS Lambda function(s) included to access AWS services. The permissions are passed in by the `sam deploy` command above. Set Value to 'Y'

### **Save arguments to samconfig.toml**: 

If set to yes, your choices will be saved to a configuration file inside the project, so that in the future you can just re-run `sam deploy` without parameters to deploy changes to your application.

Once you have set all of these options, SAM CLI will create a changeset and will display a list of all actions that will be performed as part of the changeset. If you have set "confirm changes before deploy" to "y", you will then be asked whether or nor to deploy this changeset. Choose "y" to complete the installation.

Once the Parima stack has been deployed, you will be able to find your CloudFront URL in the output values displayed after deployment.


## CloudFormation Outputs

The Parima CloudFormation generates the following outputs:
* WebsiteUrl - The Website URL
* AccessKeyId / AccessKeySecret - IAM Security credentials
* SyncCommand - The aws cli command that can be used to sync the website in the current directory with AWS
* S3Bucket - The location of the hosted website files


## Cleanup

To delete the Parima application that you created, use the AWS CLI:

```bash
aws cloudformation delete-stack --stack-name &lt;STACK_NAME&gt;
```